# üöÄ Projeto Monitoramento de Servidor Nginx na AWS

Este projeto automatiza o monitoramento e notifica√ß√£o via webhook para servidores, utilizando NGINX e AWS. Foi proposto como primeiro projeto no programa de bolsas da UOL COMPASS trilha DevSecOps.

---

## üì¶ Instala√ß√£o

```bash
# Clone o reposit√≥rio
git clone https://github.com/Ruan-Pablo-Oli/Nginx-with-monitoration.git
cd Nginx-with-monitoration
```

---

## üõ†Ô∏è Depend√™ncias

- NGINX
- AWS Account
- jq
- curl
- unzip

---

## ‚öôÔ∏è Configura√ß√£o AWS

#### 1. **Cria√ß√£o da VPC**
   
   **Primeiro passo: criar a VPC que ser√° utilizada no projeto.**
   
   - Acesse o servi√ßo VPC no console da AWS
   - No menu lateral, acesse a op√ß√£o "Your VPCs"
   - Clique em "Create VPC" 
   - Configure as seguintes op√ß√µes: 
      - VPC only
      - IPv4 CIDR manual input
      - No IPv6 CIDR block
      - Tenancy default
   - Adicione um name tag para identifica√ß√£o da VPC

   <img src="assets/Criandovpc.gif" width="500" />


#### 2. **Cria√ß√£o das Subnets**
   
   **Segundo passo: criar as subnets para a VPC criada anteriormente.**

   - Acesse a op√ß√£o "Subnets" no menu lateral do console AWS e clique em "Create subnet"
   - Selecione a VPC criada anteriormente
   - **Dica:** Primeiro escolha a regi√£o onde a VPC ser√° criada, depois nomeie de acordo com essa regi√£o
   - **Dica:** Escolha zonas de disponibilidade diferentes para as subnets quando poss√≠vel
   - Configure o IP da subnet (exemplo: 10.0.1.0/20)
   - Clique em "Create subnet"
   - Crie mais 3 subnets com IPs de rede diferentes (pr√≥xima subnet: 10.0.2.0/20)

   <img src="assets/subnet.gif" width="500" />


#### 3. **Cria√ß√£o do Internet Gateway**

   **Terceiro passo: criar o Internet Gateway para que as subnets p√∫blicas tenham acesso √† internet.**

   - Acesse a op√ß√£o "Internet Gateways" e clique em "Create Internet Gateway"
   - Adicione um name tag para identifica√ß√£o
   - Clique em "Create Internet Gateway"


#### 4. **Cria√ß√£o da Route Table**

   **Quarto passo: definir route tables para as subnets. Este processo ser√° dividido em duas partes.**

   ##### 4.1 (Criando route table e associando com internet gateway)

   - Acesse a op√ß√£o "Route Tables" no menu lateral
   - Clique em "Create route table"
   - Adicione um name tag e selecione a VPC criada no primeiro passo
   - Clique em "Create route table"
   - No campo "Routes", clique em "Edit routes"
   - Clique em "Add route"
   - Para o destino, escolha 0.0.0.0/0 (pacotes que acessar√£o a internet)
   - Escolha a op√ß√£o "Internet Gateway" e selecione o gateway criado anteriormente
   - Salve as altera√ß√µes

   ##### 4.2 (Associando subnets √† route table)

   - Saia do campo "Routes" e acesse "Subnet associations"
   - Clique em "Edit subnet associations"
   - Escolha as duas subnets que ser√£o p√∫blicas
   - Salve as associa√ß√µes
   - Para subnets privadas que precisam se comunicar entre si, crie uma tabela sem internet gateway e as associe

   <img src="assets/routeTable.gif" width="500" />

#### 5. **Cria√ß√£o do Security Group**

   **Quinto passo: criar o security group para permitir acesso SSH e HTTP ao servi√ßo.**

   - Acesse a op√ß√£o "Security Groups" na se√ß√£o Security
   - Clique em "Create security group"
   - Adicione nome, descri√ß√£o e escolha a VPC criada no primeiro passo
   - Crie duas regras Inbound: uma para SSH e outra para HTTP
   - Em "Source", configure "My IP" para restringir acesso apenas ao seu IP
   - Nas "Outbound rules", altere o destination da regra existente para "My IP"

   <img src="assets/securityGroup.gif" width="500" />


#### 6. **Bucket S3**
   **Cria√ß√£o do bucket com os arquivos que o user data utilizar√° para automatizar a configura√ß√£o da inst√¢ncia.**

   ##### 6.1 (Cria√ß√£o do bucket)

   - Acesse o servi√ßo S3 no console AWS
   - Clique em "Create bucket"
   - Configure as op√ß√µes padr√£o, alterando apenas "Bucket Key" para "Disable"
   - Nomeie o bucket conforme necess√°rio
   - Como ser√° utilizado SSE-S3 para criptografia, n√£o √© necess√°rio manter o Bucket Key habilitado

   ‚ö†Ô∏è **Importante:** Ser√° necess√°rio atualizar o nome do bucket no script user data conforme o nome escolhido.
   
   - No arquivo user data, altere os nomes dos buckets de acordo com o nome escolhido

   ![mudar_nome_bucket](assets/image.png)

   ##### 6.2 (Upload dos arquivos)
   - Acesse o bucket criado para fazer upload dos arquivos
   - No campo "Objects", clique em "Upload"
   - Fa√ßa upload dos arquivos: monitoramento.sh, index.html e styles.css
   - Mantenha todas as op√ß√µes padr√£o e clique em "Upload"

   **Nota:** √â poss√≠vel fazer upload usando AWS CLI, por√©m utilizaremos o m√©todo mais simples via console.

   <img src="assets/bucket.gif" width="500" />

#### 7. **Secrets Manager**

   ##### Obtendo o webhook do Discord

   **Como obter o webhook do Discord:**
   
   1. **Acesse o servidor Discord** onde possui permiss√µes de administrador
   2. **V√° para Configura√ß√µes do Servidor** (clique com bot√£o direito no nome do servidor)
   3. **Acesse "Integra√ß√µes"** no menu lateral
   4. **Clique em "Webhooks"** e depois em "Criar Webhook"
   5. **Configure o webhook:**
      - Defina o nome do webhook (ex: "Monitor Nginx")
      - Selecione o canal onde as notifica√ß√µes aparecer√£o
      - Copie a **URL do Webhook**
   6. **Salve as configura√ß√µes**

   ‚ö†Ô∏è **Importante:** Mantenha a URL do webhook segura - qualquer pessoa com acesso pode enviar mensagens para o servidor.

   **Configura√ß√£o do AWS Secrets Manager:**

   - Acesse o servi√ßo "Secrets Manager" no console AWS
   - Clique em "Store a new Secret"
   - Selecione a op√ß√£o "Other type of secret"
   - **Importante:** Mantenha o nome e configura√ß√£o do secret conforme especificado para o funcionamento do monitoramento.sh
   - A chave deve ser "webhook" e o valor deve ser o webhook obtido do Discord
   - Clique em "Next" e defina o secret name como exatamente "discord/webhook-api"
   - Clique em "Next", n√£o configure rotation e finalize a cria√ß√£o do secret
   
   **Exemplo:**   

     ```json
     {
       "webhook":"https://discord.com/api/webhooks/xxx/yyy"
     }
     ```


   <img src="assets/secret.gif" width="500" />








#### 8. **Permiss√µes IAM**

   **Cria√ß√£o das roles para que a inst√¢ncia EC2 possa acessar os arquivos do bucket e o secret.**

   - Acesse o servi√ßo IAM no console AWS
   - Clique em "Roles"
   - Ser√° criada uma role com duas policies: uma para acesso ao S3 e outra para acesso ao Secrets Manager
   - Clique em "Create role"
   - Selecione "AWS service" e escolha "EC2" em use case
   - Adicione as policies: "AmazonS3FullAccess" e "SecretsManagerReadWrite"
   - **Nota:** O ideal √© seguir a pol√≠tica de menor privil√©gio com policies mais espec√≠ficas, mas para ambiente de desenvolvimento, essa solu√ß√£o √© adequada
   - Clique em "Next", adicione um nome e finalize clicando em "Create role"
   
   <img src="assets/CreateRole.gif" width="500" />

#### 9. **Cria√ß√£o da EC2 com Nginx usando User Data**

   **Passo final: criar uma inst√¢ncia EC2 utilizando user data para automatiza√ß√£o.**
   
   - Acesse o servi√ßo EC2 no console AWS
   - Entre na op√ß√£o "Instances" e clique em "Launch instances"
   - Configure as tags necess√°rias
   - Selecione a AMI Ubuntu, instance type t2.micro
   - Use um key pair existente ou crie um novo para conex√£o SSH
   
   ##### 9.1 Configura√ß√£o de rede
   **Utilizando a infraestrutura de rede criada anteriormente:**
   - Na se√ß√£o "Network settings", clique em "Edit"
   - Escolha a VPC criada
   - Escolha uma das subnets p√∫blicas criadas
   - Mantenha "Auto-assign public IP" desabilitado (ser√° usado Elastic IP)
   - Selecione "Select existing security group" e escolha o security group criado
   - Em "Configure storage", escolha o tamanho da inst√¢ncia
   - Abra "Advanced details" e em "IAM instance profile" selecione a role criada
   - Em "User data", utilize o arquivo user_data.sh do reposit√≥rio ou copie o conte√∫do
   - Clique em "Launch instance"
   
   ‚ö†Ô∏è **Importante:** Lembre-se de editar o nome do bucket no user data (obrigat√≥rio) e do webhook caso tenha sido criado com outro nome.
   
   <img src="assets/ec2.gif" width="500" />

#### 10. **Associando Elastic IP √† EC2**
   **Atribuindo um IP p√∫blico √† inst√¢ncia EC2.**

   - Acesse "Elastic IPs" na se√ß√£o "Network & Security"
   - Clique em "Allocate Elastic IP address"
   - Clique em "Allocate"
   - Selecione o IP alocado e clique em "Actions"
   - Clique em "Associate Elastic IP address"
   - Em "Instance", escolha a inst√¢ncia inicializada
   - Clique em "Associate"

   <img src="assets/ip.gif" width="500" />

---

## ‚öôÔ∏è Funcionamento do monitoramento.sh

Esta se√ß√£o explica como o script de monitoramento funciona e quais comandos s√£o utilizados para verificar o status do servidor Nginx.

### üìã **Estrutura do Script**

O script `monitoramento.sh` √© respons√°vel por:
- Verificar se o servidor web Nginx est√° respondendo
- Registrar logs das verifica√ß√µes
- Enviar notifica√ß√µes via Discord quando h√° problemas

### üîß **Principais Comandos e Funcionalidades**

#### **1. Configura√ß√£o Inicial**
```bash
#!/usr/bin/env bash
set -euo pipefail
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```
- **`set -euo pipefail`**: Configura o script para sair imediatamente em caso de erro
- **`export PATH`**: Define o PATH para garantir acesso aos comandos necess√°rios j√° que vai ser rodado no cron, √© melhor garantir que todos os comandos sejam encontrados

#### **2. Vari√°veis de Ambiente**
```bash
ENV_FILE="/etc/environment"
LOGFILE="/var/log/monitoramento_logs.txt"
```
- **`ENV_FILE`**: Arquivo contendo vari√°veis de ambiente (WEBHOOK_URL, SITE_URL)
- **`LOGFILE`**: Arquivo onde s√£o registrados todos os logs do monitoramento

#### **3. Sistema de Logs**
```bash
log() {
  local ts
  ts="$(date '+%Y-%m-%d %H:%M:%S')"
  echo "[$ts] $*"
}
```
- **Fun√ß√£o `log()`**: Adiciona momento atual √†s mensagens de log
- **`date '+%Y-%m-%d %H:%M:%S'`**: ts recebe a execu√ß√£o desse comando, que retorna a data e hora atual
- **echo "[$ts] $*"**> Concatena ts com todos as argumentos passados e imprime

#### **4. Notifica√ß√£o Discord**
```bash
notify_discord() {
  local content="$1"
  curl -sS -H "Content-Type: application/json" \
       -d "$(printf '{"content":"%s"}' "$content")" \
       "$WEBHOOK_URL" || true
}
```
- **`curl -sS`**: Faz requisi√ß√£o HTTP silenciosa ao webhook do Discord
- **`Content-Type: application/json`**: Define o tipo de conte√∫do como JSON
- **`|| true`**: Garante que o script continue mesmo se a notifica√ß√£o falhar

#### **5. Verifica√ß√£o de Arquivo de Ambiente**
```bash
[! -e "$ENV_FILE" ] && log "ERROR. Arquivo $ENV_FILE n√£o encontrado!" && exit 1
[ ! -r "$ENV_FILE" ] && log "ERROR. Sem permiss√£o de leitura em $ENV_FILE" && exit 1
source "$ENV_FILE"
```
- **`[! -e "$ENV_FILE" ]`**: Verifica se o arquivo existe
- **`[ ! -r "$ENV_FILE" ]`**: Verifica se h√° permiss√£o de leitura
- **`source "$ENV_FILE"`**: Carrega as vari√°veis de ambiente

#### **6. Sistema de Lock (Preven√ß√£o de Execu√ß√£o Simult√¢nea)**
```bash
exec 9>"/var/lock/monitoramento.lock" || exit 1
flock -n 9 || exit 0
```
- **`exec 9>`**: Abre um file descriptor para o arquivo de lock
- **`flock -n 9`**: Tenta obter um lock n√£o-bloqueante
- **Faz com que m√∫ltiplas inst√¢ncias n√£o rodem ao mesmo tempo**: Importante porque ao usar o cron, o script vai ser executado m√∫ltiplas vezes
#### **7. Verifica√ß√£o HTTP do Servidor**
```bash
HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" --max-time 10 "$SITE_URL" || echo "000")
```
- **`curl -o /dev/null`**: Descarta o conte√∫do da resposta pois o caminho /dev/null apaga qualquer coisa que for enviado
- **`-s`**: Modo silencioso (sem mostrar progresso)
- **`-w "%{http_code}"`**: Retorna apenas o c√≥digo de status HTTP
- **`--max-time 10`**: Timeout de 10 segundos
- **`|| echo "000"`**: Retorna "000" em caso de erro de conex√£o

#### **8. An√°lise do Resultado e Notifica√ß√£o**
```bash
if [[ "$HTTP_CODE" != "200" ]]; then
  msg="O site est√° fora do ar! C√≥digo HTTP: $HTTP_CODE."
  log "$msg"
  notify_discord ":x: $msg"
else
  log "Site $SITE_URL OK (HTTP 200)."
fi
```
- **Verifica se o c√≥digo HTTP √© 200** (sucesso)
- **Se diferente de 200**: Registra erro e envia notifica√ß√£o ao Discord
- **Se igual a 200**: Registra que o site est√° funcionando

---

## üöÄ Funcionamento do user_data.sh

Esta se√ß√£o explica como o script user data funciona para automatizar a configura√ß√£o completa da inst√¢ncia EC2 durante sua inicializa√ß√£o.

### üìã **Estrutura do Script**

O script `user_data.sh` √© respons√°vel por:
- Instalar e configurar o servidor web Nginx
- Baixar arquivos necess√°rios do bucket S3
- Configurar vari√°veis de ambiente
- Configurar monitoramento autom√°tico via cron
- Garantir que todos os servi√ßos iniciem automaticamente

### üîß **Principais Comandos e Funcionalidades**

#### **1. Configura√ß√£o Inicial e Instala√ß√£o de Pacotes**
```bash
#!/bin/bash
set -e
apt update -y
apt install -y nginx unzip curl jq
```
- **`set -e`**: Para a execu√ß√£o se algum comando falhar
- **`apt update -y`**: Atualiza a lista de pacotes dispon√≠veis
- **`apt install -y`**: Instala Nginx, unzip, curl e jq automaticamente

#### **2. Instala√ß√£o do AWS CLI v2**
```bash
cd /tmp
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip -o awscliv2.zip
sudo ./aws/install
export PATH=$PATH:/usr/local/bin
```
- **`cd /tmp`**: Muda para diret√≥rio tempor√°rio
- **`curl`**: Baixa o AWS CLI v2 diretamente da AWS
- **`unzip -o`**: Extrai o arquivo sobrescrevendo se j√° existir
- **`sudo ./aws/install`**: Instala o AWS CLI no sistema
- **`export PATH`**: Adiciona o AWS CLI ao PATH para uso imediato

#### **3. Defini√ß√£o de Vari√°veis**
```bash
NOME_BUCKET="COLOQUE_AQUI_O_NOME_DO_BUCKET"
NOME_WEBHOOK="COLOQUE_AQUI_O_NOME_DO_WEBHOOK"
```
- **Vari√°veis customiz√°veis**: Devem ser editadas antes do deploy
- **`NOME_BUCKET`**: Nome do bucket S3 onde est√£o os arquivos
- **`NOME_WEBHOOK`**: Nome do secret no Secrets Manager

#### **4. Download e Configura√ß√£o de Arquivos do S3**
```bash
aws s3 cp s3://$NOME_BUCKET/monitoramento.sh /usr/local/bin/monitoramento.sh
chmod 755 /usr/local/bin/monitoramento.sh

aws s3 cp s3://$NOME_BUCKET/index.html /var/www/html/index.html
chmod 644 /var/www/html/index.html

aws s3 cp s3://$NOME_BUCKET/styles.css /var/www/html/styles.css
chmod 644 /var/www/html/styles.css
```
- **`aws s3 cp`**: Copia arquivos do bucket S3 para a inst√¢ncia
- **`chmod 755`**: Torna o script execut√°vel (rwxr-xr-x)
- **`chmod 644`**: Define permiss√µes de leitura para arquivos web (rw-r--r--)
- **Destinos**: Script vai para `/usr/local/bin/`, arquivos web para `/var/www/html/`

#### **5. Configura√ß√£o de Vari√°veis de Ambiente**
```bash
WEBHOOK_URL=$(aws secretsmanager get-secret-value --secret-id $NOME_WEBHOOK --query 'SecretString' --output text | jq -r '.webhook')

touch /etc/environment
echo "WEBHOOK_URL=\"$WEBHOOK_URL\"" >> /etc/environment
echo 'SITE_URL="127.0.0.1"' >> /etc/environment
```
- **`aws secretsmanager get-secret-value`**: Recupera o webhook do Discord do Secrets Manager
- **`jq -r '.webhook'`**: Extrai apenas o valor do webhook do JSON
- **`touch /etc/environment`**: Cria o arquivo de vari√°veis de ambiente se n√£o existir
- **`echo >> /etc/environment`**: Adiciona as vari√°veis ao arquivo

#### **6. Configura√ß√£o de Auto-restart do Nginx**
```bash
mkdir -p /etc/systemd/system/nginx.service.d
cat >/etc/systemd/system/nginx.service.d/override.conf <<EOF
[Service]
Restart=always
RestartSec=5
EOF
```
- **`mkdir -p`**: Cria diret√≥rio para configura√ß√µes customizadas do systemd
- **`cat > override.conf`**: Cria arquivo de configura√ß√£o override
- **`Restart=always`**: Configura Nginx para reiniciar automaticamente em caso de falha
- **`RestartSec=5`**: Define 5 segundos de intervalo entre tentativas de restart

#### **7. Ativa√ß√£o e Inicializa√ß√£o dos Servi√ßos**
```bash
systemctl daemon-reload
systemctl enable nginx
systemctl restart nginx
```
- **`systemctl daemon-reload`**: Recarrega configura√ß√µes do systemd
- **`systemctl enable nginx`**: Configura Nginx para iniciar automaticamente no boot
- **`systemctl restart nginx`**: Reinicia o Nginx com as novas configura√ß√µes

#### **8. Configura√ß√£o do Cron para Monitoramento**
```bash
sudo bash -c '
(crontab -l 2>/dev/null | grep -v "/usr/local/bin/monitoramento.sh" | grep -v "/var/log/monitoramento_logs.txt"
echo "* * * * * /usr/local/bin/monitoramento.sh >> /var/log/monitoramento_logs.txt 2>&1"
echo "0 0 * * * > /var/log/monitoramento_logs.txt"
) | crontab -
'
```
- **`crontab -l`**: Lista o cron atual
- **`grep -v`**: Remove entradas existentes do monitoramento para evitar duplicatas
- **`* * * * *`**: Executa o script a cada minuto
- **`0 0 * * *`**: Limpa os logs √† meia-noite todos os dias
- **`2>&1`**: Redireciona erros para o arquivo de log
- **`crontab -`**: Instala a nova configura√ß√£o do cron

#### TESTES

   #### **Nginx**
   - A ec2 j√° inicia com nginx rodando e um service, √© poss√≠vel ver isso com o comando: 
   ```bash
      sudo systemctl status nginx
   ```
   <img src="assets/nginx.png" width="500" />

   #### **Crontab**
   - Ap√≥s inicar a inst√¢ncia com userData, as tarefas foram agendadas no crontab. √â poss√≠vel ver isso com o comando:

      ```bash
         sudo crontab -l
      ```
   <img src="assets/crontab.png" width="500" />

   ### **Monitoramento**

   - Como o script de monitoramento j√° foi agendado, os seus logs j√° est√£o sendo colocados em /var/log/monitoramento_logs.txt
   - √â poss√≠vel ver isso com o comando:
   ```bash
      sudo cat /var/log/monitoramento_logs.txt
   ```

   <img src="assets/logs.png" width="500" />

   ### **Webhook Discord**
   - Para testar o webhook, pare o servi√ßo do nginx com o comando abaixo e espera 1 minuto ou execute o script de monitoramento manualmente

   ```bash
      sudo systemctl stop nginx
      sudo /usr/local/bin/.monitoramento.sh
   ```
   - Tanto ser√° notificado no discord como √© poss√≠vel ver a sa√≠da nos logs usando o comando: 
   ```bash
      sudo tail -n 10 /var/log/monitoramento_logs.txt
   ```
   <img src="assets/teste_log.png" width="500" />
   <img src="assets/teste_webhook.png" width="500" />



## üïí Agendamentos Cron

- `monitoramento.sh` roda a cada minuto.
- Logs s√£o limpos diariamente √† meia-noite.

---

## üí° Como Usar

- Acesse o IP p√∫blico da inst√¢ncia para visualizar o status do monitoramento
- Consulte os logs em `/var/log/monitoramento_logs.txt`
- As notifica√ß√µes ser√£o enviadas automaticamente para o Discord configurado
- **LEMBRE-SE, NO SECURITY GROUP APENAS SEU IP FOI PERMITIDO PARA ACESSAR A INST√ÇNCIA.**
- **APENAS SUA M√ÅQUINA PODER√Å ACESSAR O WEB SERVER**
---

