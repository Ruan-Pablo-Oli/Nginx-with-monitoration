# üöÄ Projeto Monitoramento de Servidor Nginx na AWS

Este projeto automatiza o monitoramento e notifica√ß√£o via webhook para servidores, utilizando NGINX e AWS. Foi proposto como primeiro projeto no programa de bolsas da UOL COMPASS trilha DevSecOps.

---

## üì¶ Instala√ß√£o

```bash
# Clone o reposit√≥rio
git clone https://github.com/Ruan-Pablo-Oli/Nginx-with-monitoration.git
cd Nginx-with-monitoration
```

---

## üõ†Ô∏è Depend√™ncias

- NGINX
- AWS Account
- jq
- curl
- unzip

---

## ‚öôÔ∏è Configura√ß√£o AWS

#### 1. **Cria√ß√£o da VPC**
   
   **Primeiro passo: criar a VPC que ser√° utilizada no projeto.**
   
   - Acesse o servi√ßo VPC no console da AWS
   - No menu lateral, acesse a op√ß√£o "Your VPCs"
   - Clique em "Create VPC" 
   - Configure as seguintes op√ß√µes: 
      - VPC only
      - IPv4 CIDR manual input
      - No IPv6 CIDR block
      - Tenancy default
   - Adicione um name tag para identifica√ß√£o da VPC

   <img src="assets/Criandovpc.gif" width="500" />


#### 2. **Cria√ß√£o das Subnets**
   
   **Segundo passo: criar as subnets para a VPC criada anteriormente.**

   - Acesse a op√ß√£o "Subnets" no menu lateral do console AWS e clique em "Create subnet"
   - Selecione a VPC criada anteriormente
   - **Dica:** Primeiro escolha a regi√£o onde a VPC ser√° criada, depois nomeie de acordo com essa regi√£o
   - **Dica:** Escolha zonas de disponibilidade diferentes para as subnets quando poss√≠vel
   - Configure o IP da subnet (exemplo: 10.0.1.0/20)
   - Clique em "Create subnet"
   - Crie mais 3 subnets com IPs de rede diferentes (pr√≥xima subnet: 10.0.2.0/20)

   <img src="assets/subnet.gif" width="500" />


#### 3. **Cria√ß√£o do Internet Gateway**

   **Terceiro passo: criar o Internet Gateway para que as subnets p√∫blicas tenham acesso √† internet.**

   - Acesse a op√ß√£o "Internet Gateways" e clique em "Create Internet Gateway"
   - Adicione um name tag para identifica√ß√£o
   - Clique em "Create Internet Gateway"


#### 4. **Cria√ß√£o da Route Table**

   **Quarto passo: definir route tables para as subnets. Este processo ser√° dividido em duas partes.**

   ##### 4.1 (Criando route table e associando com internet gateway)

   - Acesse a op√ß√£o "Route Tables" no menu lateral
   - Clique em "Create route table"
   - Adicione um name tag e selecione a VPC criada no primeiro passo
   - Clique em "Create route table"
   - No campo "Routes", clique em "Edit routes"
   - Clique em "Add route"
   - Para o destino, escolha 0.0.0.0/0 (pacotes que acessar√£o a internet)
   - Escolha a op√ß√£o "Internet Gateway" e selecione o gateway criado anteriormente
   - Salve as altera√ß√µes

   ##### 4.2 (Associando subnets √† route table)

   - Saia do campo "Routes" e acesse "Subnet associations"
   - Clique em "Edit subnet associations"
   - Escolha as duas subnets que ser√£o p√∫blicas
   - Salve as associa√ß√µes
   - Para subnets privadas que precisam se comunicar entre si, crie uma tabela sem internet gateway e as associe

   <img src="assets/routeTable.gif" width="500" />

#### 5. **Cria√ß√£o do Security Group**

   **Quinto passo: criar o security group para permitir acesso SSH e HTTP ao servi√ßo.**

   - Acesse a op√ß√£o "Security Groups" na se√ß√£o Security
   - Clique em "Create security group"
   - Adicione nome, descri√ß√£o e escolha a VPC criada no primeiro passo
   - Crie duas regras Inbound: uma para SSH e outra para HTTP
   - Em "Source", configure "My IP" para restringir acesso apenas ao seu IP
   - Nas "Outbound rules", altere o destination da regra existente para "My IP"

   <img src="assets/securityGroup.gif" width="500" />


#### 6. **Bucket S3**
   **Cria√ß√£o do bucket com os arquivos que o user data utilizar√° para automatizar a configura√ß√£o da inst√¢ncia.**

   ##### 6.1 (Cria√ß√£o do bucket)

   - Acesse o servi√ßo S3 no console AWS
   - Clique em "Create bucket"
   - Configure as op√ß√µes padr√£o, alterando apenas "Bucket Key" para "Disable"
   - Nomeie o bucket conforme necess√°rio
   - Como ser√° utilizado SSE-S3 para criptografia, n√£o √© necess√°rio manter o Bucket Key habilitado

   ‚ö†Ô∏è **Importante:** Ser√° necess√°rio atualizar o nome do bucket no script user data conforme o nome escolhido.
   
   - No arquivo user data, altere os nomes dos buckets de acordo com o nome escolhido

   ![mudar_nome_bucket](assets/image.png)

   ##### 6.2 (Upload dos arquivos)
   - Acesse o bucket criado para fazer upload dos arquivos
   - No campo "Objects", clique em "Upload"
   - Fa√ßa upload dos arquivos: monitoramento.sh, index.html e styles.css
   - Mantenha todas as op√ß√µes padr√£o e clique em "Upload"

   **Nota:** √â poss√≠vel fazer upload usando AWS CLI, por√©m utilizaremos o m√©todo mais simples via console.

   <img src="assets/bucket.gif" width="500" />

#### 7. **Secrets Manager**

   ##### Obtendo o webhook do Discord

   **Como obter o webhook do Discord:**
   
   1. **Acesse o servidor Discord** onde possui permiss√µes de administrador
   2. **V√° para Configura√ß√µes do Servidor** (clique com bot√£o direito no nome do servidor)
   3. **Acesse "Integra√ß√µes"** no menu lateral
   4. **Clique em "Webhooks"** e depois em "Criar Webhook"
   5. **Configure o webhook:**
      - Defina o nome do webhook (ex: "Monitor Nginx")
      - Selecione o canal onde as notifica√ß√µes aparecer√£o
      - Copie a **URL do Webhook**
   6. **Salve as configura√ß√µes**

   ‚ö†Ô∏è **Importante:** Mantenha a URL do webhook segura - qualquer pessoa com acesso pode enviar mensagens para o servidor.

   **Configura√ß√£o do AWS Secrets Manager:**

   - Acesse o servi√ßo "Secrets Manager" no console AWS
   - Clique em "Store a new Secret"
   - Selecione a op√ß√£o "Other type of secret"
   - **Importante:** Mantenha o nome e configura√ß√£o do secret conforme especificado para o funcionamento do monitoramento.sh
   - A chave deve ser "webhook" e o valor deve ser o webhook obtido do Discord
   - Clique em "Next" e defina o secret name como exatamente "discord/webhook-api"
   - Clique em "Next", n√£o configure rotation e finalize a cria√ß√£o do secret
   
   **Exemplo:**   

     ```json
     {
       "webhook":"https://discord.com/api/webhooks/xxx/yyy"
     }
     ```


   <img src="assets/secret.gif" width="500" />








#### 8. **Permiss√µes IAM**

   **Cria√ß√£o das roles para que a inst√¢ncia EC2 possa acessar os arquivos do bucket e o secret.**

   - Acesse o servi√ßo IAM no console AWS
   - Clique em "Roles"
   - Ser√° criada uma role com duas policies: uma para acesso ao S3 e outra para acesso ao Secrets Manager
   - Clique em "Create role"
   - Selecione "AWS service" e escolha "EC2" em use case
   - Adicione as policies: "AmazonS3FullAccess" e "SecretsManagerReadWrite"
   - **Nota:** O ideal √© seguir a pol√≠tica de menor privil√©gio com policies mais espec√≠ficas, mas para ambiente de desenvolvimento, essa solu√ß√£o √© adequada
   - Clique em "Next", adicione um nome e finalize clicando em "Create role"
   
   <img src="assets/CreateRole.gif" width="500" />

#### 9. **Cria√ß√£o da EC2 com Nginx usando User Data**

   **Passo final: criar uma inst√¢ncia EC2 utilizando user data para automatiza√ß√£o.**
   
   - Acesse o servi√ßo EC2 no console AWS
   - Entre na op√ß√£o "Instances" e clique em "Launch instances"
   - Configure as tags necess√°rias
   - Selecione a AMI Ubuntu, instance type t2.micro
   - Use um key pair existente ou crie um novo para conex√£o SSH
   
   ##### 9.1 Configura√ß√£o de rede
   **Utilizando a infraestrutura de rede criada anteriormente:**
   - Na se√ß√£o "Network settings", clique em "Edit"
   - Escolha a VPC criada
   - Escolha uma das subnets p√∫blicas criadas
   - Mantenha "Auto-assign public IP" desabilitado (ser√° usado Elastic IP)
   - Selecione "Select existing security group" e escolha o security group criado
   - Em "Configure storage", escolha o tamanho da inst√¢ncia
   - Abra "Advanced details" e em "IAM instance profile" selecione a role criada
   - Em "User data", utilize o arquivo user_data.sh do reposit√≥rio ou copie o conte√∫do
   - Clique em "Launch instance"
   
   ‚ö†Ô∏è **Importante:** Lembre-se de editar o nome do bucket no user data (obrigat√≥rio) e do webhook caso tenha sido criado com outro nome.
   
   <img src="assets/ec2.gif" width="500" />

#### 10. **Associando Elastic IP √† EC2**
   **Atribuindo um IP p√∫blico √† inst√¢ncia EC2.**

   - Acesse "Elastic IPs" na se√ß√£o "Network & Security"
   - Clique em "Allocate Elastic IP address"
   - Clique em "Allocate"
   - Selecione o IP alocado e clique em "Actions"
   - Clique em "Associate Elastic IP address"
   - Em "Instance", escolha a inst√¢ncia inicializada
   - Clique em "Associate"

   <img src="assets/ip.gif" width="500" />

---

## ‚öôÔ∏è Funcionamento monitoramento.




---
## üïí Agendamentos Cron

- `monitoramento.sh` roda a cada minuto.
- Logs s√£o limpos diariamente √† meia-noite.

---

## üí° Como Usar

- Acesse o IP p√∫blico da inst√¢ncia para visualizar o status do monitoramento
- Consulte os logs em `/var/log/monitoramento_logs.txt`
- As notifica√ß√µes ser√£o enviadas automaticamente para o Discord configurado

---

## üîê Seguran√ßa

‚ö†Ô∏è **Importante:**
- Nunca compartilhe credenciais AWS
- Mantenha webhooks do Discord privados
- Use IAM roles com menor privil√©gio poss√≠vel
- Monitore os logs de acesso regularmente
- Configure adequadamente os Security Groups

---

## üìù Contribui√ß√µes

Contribui√ß√µes s√£o bem-vindas! Para contribuir:
1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

---

## ü§ù Licen√ßa

Este projeto est√° licenciado sob a Licen√ßa MIT - veja o arquivo [LICENSE](LICENSE) para detalhes.

---

## üì´ Contato

Para d√∫vidas ou sugest√µes, entre em contato atrav√©s do GitHub Issues.

---

## üôè Agradecimentos

Projeto desenvolvido como parte do programa de bolsas UOL COMPASS - trilha DevSecOps.